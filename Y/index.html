<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rarity Clicker ‚Äì Bubblegum Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Import Bubblegum Sans font -->
    <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Header: Timer and Settings Icon -->
    <div id="header">
      <div id="timer">Time: 0.00s</div>
      <div id="settingsIcon" onclick="toggleSettingsModal()">‚öôÔ∏è</div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="toggleSettingsModal()">&times;</span>
        <h3>Settings</h3>

        <!-- Shop Upgrades Section -->
        <div class="shop-section">
          <h4>Shop Upgrades</h4>
          <p>Points: <span id="pointsDisplay">0</span></p>
          <button id="autoClickerBtn" onclick="purchaseAutoClicker()">Buy Auto Clicker (50 pts)</button>
          <button id="doublePointsBtn" onclick="purchaseDoublePoints()">Buy Double Points (150 pts)</button>
          <button id="goldenClickBtn" onclick="purchaseGoldenClick()">Buy Golden Click (200 pts)</button>
          <button id="luckBoostBtn" onclick="purchaseLuckBoost()">Buy Luck Boost (300 pts)</button>
          <button id="timeFreezeBtn" onclick="purchaseTimeFreeze()">Buy Time Freeze (200 pts)</button>
          <button id="goldenModeBtn" onclick="purchaseGoldenMode()">Buy Golden Mode (1500 pts)</button>
          <!-- New Shop Items -->
          <button id="timeWarpBtn" onclick="purchaseTimeWarp()">Buy Time Warp (500 pts)</button>
          <button id="stabilizerBtn" onclick="purchaseStabilizer()">Buy Stabilizer (1200 pts)</button>
          <p>Auto Clickers: <span id="autoCount">0</span></p>
          <p>Double Points: <span id="doubleStatus">Off</span></p>
          <p>Golden Click: <span id="goldenStatus">Not Ready</span></p>
          <p>Luck Boost: <span id="luckBoostStatus">Inactive</span></p>
          <p>Time Freeze: <span id="timeFreezeStatus">Inactive</span></p>
          <p>Golden Mode: <span id="goldenModeStatus">Inactive</span></p>
        </div>

        <!-- Upstage Button (if rarities up through Impossible are unlocked) -->
        <button id="upstageButton" onclick="upstageGame()" style="display:none; background: orange;">UPSTAGE?</button>
        <hr />

        <!-- Background Shop Section -->
        <div class="background-shop-section">
          <h4>Background Shop</h4>
          <ul id="backgroundShopList"></ul>
        </div>
        <hr />

        <!-- Stats for Nerds Section -->
        <div class="stats-section">
          <h4>Stats for Nerds</h4>
          <p>Total Clicks: <span id="totalClicks">0</span></p>
          <p>Rarest Find: <span id="rarestFind">None</span></p>
          <div>
            <h5>Rarity Chances:</h5>
            <ul id="chancesList"></ul>
          </div>
          <p id="masteryMedals">Mastery Medals: </p>
        </div>
        <hr />
        <button id="resetButton" onclick="resetGame()">RESET</button>
      </div>
    </div>

    <!-- Main Clickable Button -->
    <button id="clickButton">Click Me!</button>

    <!-- Result Container -->
    <div id="resultContainer">
      <p id="result"></p>
    </div>

    <!-- Log of Unique Finds -->
    <h2>Log of Finds</h2>
    <ul id="log"></ul>

    <script>
      /******** Global Variables & Persistent Storage ********/
      let points = localStorage.getItem("points") ? parseInt(localStorage.getItem("points")) : 0;
      let startTime = localStorage.getItem("startTime") ? parseInt(localStorage.getItem("startTime")) : Date.now();
      localStorage.setItem("startTime", startTime);
      let autoClickersCount = 0, autoInterval = null;
      let doublePointsActive = false, goldenClickReady = false;
      let luckBoostActive = false, timeFreezeActive = false, goldenModeActive = false;
      let totalClicks = localStorage.getItem("totalClicks") ? parseInt(localStorage.getItem("totalClicks")) : 0;
      let logData = JSON.parse(localStorage.getItem("logData")) || [];
      let shopPriceMultiplier = localStorage.getItem("shopPriceMultiplier") ? parseFloat(localStorage.getItem("shopPriceMultiplier")) : 1;
      let upstageCount = localStorage.getItem("upstageCount") ? parseInt(localStorage.getItem("upstageCount")) : 0;

      // New buff flags
      let stabilizerActive = false;
      let timeWarpActive = false;

      /******** Rarity Definitions ********/
      // 88 rarities across 9 tiers. Golden click/mode now guarantee selection from Tier 5 (Legendary) or higher.
      const rarities = [
        // Tier 1: Common (40%)
        { name: "Dusty", chance: 15 },
        { name: "Basic", chance: 8 },
        { name: "Standard", chance: 6 },
        { name: "Plain", chance: 4 },
        { name: "Faded", chance: 3 },
        { name: "Neutral", chance: 2 },
        { name: "Average", chance: 1.5 },
        { name: "Typical", chance: 0.5 },
        // Tier 2: Uncommon (25%)
        { name: "Uncommon", chance: 6 },
        { name: "Distinct", chance: 4 },
        { name: "Noticeable", chance: 3 },
        { name: "Elevated", chance: 2.5 },
        { name: "Unique", chance: 2 },
        { name: "Rareish", chance: 1.5 },
        { name: "Vibrant", chance: 1.2 },
        { name: "Striking", chance: 1.1 },
        { name: "Polished", chance: 1 },
        { name: "Featured", chance: 0.7 },
        { name: "Specialty", chance: 0.5 },
        // Tier 3: Rare (14%)
        { name: "Rare", chance: 3 },
        { name: "Pristine", chance: 2.5 },
        { name: "Hidden", chance: 2 },
        { name: "Sleek", chance: 1.8 },
        { name: "Shimmering", chance: 1.5 },
        { name: "Vivid", chance: 1.2 },
        { name: "Brilliant", chance: 1 },
        { name: "Prominent", chance: 0.8 },
        { name: "Gemlike", chance: 0.7 },
        { name: "Exotic", chance: 0.5 },
        // Tier 4: Epic (10%)
        { name: "Epic", chance: 2.5 },
        { name: "Dynamic", chance: 2 },
        { name: "Complex", chance: 1.5 },
        { name: "Unbelievable", chance: 1.2 },
        { name: "Experimental", chance: 1 },
        { name: "Transcendent", chance: 0.8 },
        { name: "Phenomenal", chance: 0.7 },
        { name: "Visionary", chance: 0.5 },
        { name: "Supreme", chance: 0.3 },
        { name: "Celestial", chance: 0.2 },
        // Tier 5: Legendary (6%)
        { name: "Legendary", chance: 1.5 },
        { name: "Revered", chance: 1.2 },
        { name: "Hallmarked", chance: 1.1 },
        { name: "Fabled", chance: 1 },
        { name: "Unmatched", chance: 0.7 },
        { name: "Mythological", chance: 0.5 },
        // Tier 6: Mythic (3%)
        { name: "Astral", chance: 0.8 },
        { name: "Cosmic", chance: 0.7 },
        { name: "Hyper", chance: 0.6 },
        { name: "Illusive", chance: 0.5 },
        { name: "Ancient", chance: 0.4 },
        // Tier 7: Impossible (1.5%)
        { name: "Forbidden", chance: 0.5 },
        { name: "Beyond", chance: 0.4 },
        { name: "Paranormal", chance: 0.3 },
        { name: "Supernatural", chance: 0.2 },
        { name: "Enigmatic", chance: 0.1 },
        // Tier 8: Ultra-Rare (0.5%)
        { name: "Miraculous", chance: 0.1 },
        { name: "Unattainable", chance: 0.08 },
        { name: "Ethereal", chance: 0.07 },
        { name: "Extraordinary", chance: 0.06 },
        { name: "Stellar", chance: 0.05 },
        // Tier 9: Beyond Reality (0.006%)
        { name: "Glitched", chance: 0.001 },  // Hidden until unlocked
        { name: "Unknown", chance: 0.002 },
        { name: "Fractured", chance: 0.0015 },
        { name: "Singularity", chance: 0.0012 },
        { name: "Timeless", chance: 0.0003 }
      ];

      // Rarity Points used for filtering (Tier 5 or above must be Legendary or higher)
      const rarityPoints = {
        "Dusty": 0, "Basic": 0, "Standard": 0, "Plain": 0, "Faded": 0, "Neutral": 0, "Average": 0, "Typical": 0,
        "Uncommon": 0, "Distinct": 0, "Noticeable": 0, "Elevated": 0, "Unique": 0, "Rareish": 0, "Vibrant": 0, "Striking": 0, "Polished": 0, "Featured": 0, "Specialty": 0,
        "Rare": 1, "Pristine": 1, "Hidden": 1, "Sleek": 1, "Shimmering": 1, "Vivid": 1, "Brilliant": 1, "Prominent": 1, "Gemlike": 1, "Exotic": 1,
        "Epic": 2, "Dynamic": 2, "Complex": 2, "Unbelievable": 2, "Experimental": 2, "Transcendent": 2, "Phenomenal": 2, "Visionary": 2, "Supreme": 2, "Celestial": 2,
        "Legendary": 3, "Revered": 3, "Hallmarked": 3, "Fabled": 3, "Unmatched": 3, "Mythological": 3,
        "Astral": 4, "Cosmic": 4, "Hyper": 4, "Illusive": 4, "Ancient": 4,
        "Forbidden": 5, "Beyond": 5, "Paranormal": 5, "Supernatural": 5, "Enigmatic": 5,
        "Miraculous": 6, "Unattainable": 6, "Ethereal": 6, "Extraordinary": 6, "Stellar": 6,
        "Glitched": 7, "Unknown": 7, "Fractured": 7, "Singularity": 7, "Timeless": 7
      };

      // --- Background and Seasonal Data (omitted for brevity) ---
      const backgroundsPermanent = {}; 
      const seasonalMainBackgrounds = [];
      const seasonalEventBackgrounds = [];
      let ownedBackgrounds = JSON.parse(localStorage.getItem("ownedBackgrounds")) || {};
      let activeBackground = localStorage.getItem("activeBackground") || "Light Blue";
      let ownedSeasonalBackgrounds = JSON.parse(localStorage.getItem("ownedSeasonalBackgrounds")) || {};
      let activeSeasonalBackground = localStorage.getItem("activeSeasonalBackground") || "";

      /******** Timer Update (every 100ms) ********/
      function updateTimer() {
        if (!timeFreezeActive) {
          const now = Date.now();
          const secondsElapsed = ((now - startTime) / 1000).toFixed(2);
          document.getElementById("timer").innerText = "Time: " + secondsElapsed + "s";
          localStorage.setItem("startTime", startTime);
        }
      }
      setInterval(updateTimer, 100);

      /******** Display Update Functions ********/
      function updateShopDisplays() {
        document.getElementById("pointsDisplay").innerText = points;
        document.getElementById("autoCount").innerText = autoClickersCount;
        document.getElementById("doubleStatus").innerText = doublePointsActive ? "On" : "Off";
        document.getElementById("goldenStatus").innerText = goldenClickReady ? "Ready" : "Not Ready";
        document.getElementById("luckBoostStatus").innerText = luckBoostActive ? "Active" : "Inactive";
        document.getElementById("timeFreezeStatus").innerText = timeFreezeActive ? "Active" : "Inactive";
        document.getElementById("goldenModeStatus").innerText = goldenModeActive ? "Active" : "Inactive";
      }

      function updateLogElement() {
        const logElem = document.getElementById("log");
        logElem.innerHTML = "";
        logData.sort((a, b) => (rarityPoints[a] || 0) - (rarityPoints[b] || 0));
        logData.forEach(rarity => {
          let li = document.createElement("li");
          li.textContent = rarity;
          li.className = rarity.toLowerCase().replace(/ /g, "-");
          logElem.appendChild(li);
        });
      }
      updateLogElement();

      function updateStats() {
        document.getElementById("totalClicks").textContent = totalClicks;
        let rarestValue = 0, rarest = "None";
        logData.forEach(rarityName => {
          let value = rarityPoints[rarityName] || 0;
          if (value > rarestValue) {
            rarestValue = value;
            rarest = rarityName;
          }
        });
        document.getElementById("rarestFind").textContent = rarest;

        const chancesList = document.getElementById("chancesList");
        chancesList.innerHTML = "";
        rarities.forEach(rarity => {
          // Only display "Glitched" chance if already unlocked.
          if (rarity.name === "Glitched" && !logData.includes("Glitched")) return;
          let li = document.createElement("li");
          li.textContent = logData.includes(rarity.name)
            ? (rarity.name + ": " + rarity.chance + "%")
            : "???";
          chancesList.appendChild(li);
        });

        let medal1 = rarities.every(r => logData.includes(r.name)) ? "üèÖ" : "";
        let permanentUnlocked = Object.keys(backgroundsPermanent).every(key => ownedBackgrounds[key]);
        let seasonalMainUnlocked = seasonalMainBackgrounds.every(bg => ownedSeasonalBackgrounds[bg.name]);
        let seasonalEventUnlocked = seasonalEventBackgrounds.every(bg => ownedSeasonalBackgrounds[bg.name]);
        let medal2 = (permanentUnlocked && seasonalMainUnlocked && seasonalEventUnlocked) ? "üèÖ" : "";
        let medal3 = (upstageCount > 0) ? "üèÖ" : "";
        let medals = medal1 + medal2 + medal3;
        document.getElementById("masteryMedals").innerText = "Mastery Medals: " + medals;

        let indexImpossible = rarities.findIndex(r => r.name === "Impossible");
        let raritiesUpToImpossible = rarities.filter((r, i) => i <= indexImpossible);
        let unlockUpstage = raritiesUpToImpossible.every(r => logData.includes(r.name));
        document.getElementById("upstageButton").style.display = unlockUpstage ? "block" : "none";
      }
      updateStats();

      /******** Rarity Generation & Purchase Functions ********/
      function generateRarity(isManual = true) {
        totalClicks++;
        localStorage.setItem("totalClicks", totalClicks);

        // Glitched chance check (only if all non-Glitched rarities are unlocked)
        let canGlitch = rarities.every(r => r.name === "Glitched" || logData.includes(r.name));
        if (canGlitch && Math.random() < 0.00001) {
          logData.push("Glitched");
          points += rarityPoints["Glitched"];
          localStorage.setItem("logData", JSON.stringify(logData));
          updateLogElement();
          updateStats();
          document.getElementById("result").innerText = "You got: Glitched (+" + rarityPoints["Glitched"] + " pts)";
          document.getElementById("result").className = "glitched";
          localStorage.setItem("points", points);
          updateShopDisplays();
          return;
        }

        let foundRarity = "";
        let multiplier = 1;
        if (isManual && goldenClickReady) {
          // For Golden Click, select only from Tier 5 (Legendary) or above.
          let eligible = rarities.filter(r => (rarityPoints[r.name] || 0) >= rarityPoints["Legendary"]);
          let totalChance = eligible.reduce((sum, r) => sum + r.chance, 0);
          let roll = Math.random() * totalChance;
          let cumulative = 0;
          for (const r of eligible) {
            cumulative += r.chance;
            if (roll <= cumulative) {
              foundRarity = r.name;
              break;
            }
          }
          goldenClickReady = false;
          console.log("Golden Click applied ‚Äì guaranteed Legendary or higher.");
        } else if (goldenModeActive) {
          let eligible = rarities.filter(r => (rarityPoints[r.name] || 0) >= rarityPoints["Legendary"]);
          let totalChance = eligible.reduce((sum, r) => sum + r.chance, 0);
          let roll = Math.random() * totalChance;
          let cumulative = 0;
          for (const r of eligible) {
            cumulative += r.chance;
            if (roll <= cumulative) {
              foundRarity = r.name;
              break;
            }
          }
        } else if (luckBoostActive) {
          let roll = Math.random() * 100;
          let cumulative = 0;
          for (const r of rarities) {
            if (r.name === "Glitched") continue;
            cumulative += r.chance;
            if (roll <= cumulative) {
              foundRarity = r.name;
              break;
            }
          }
        } else {
          let roll = Math.random() * 100;
          let cumulative = 0;
          for (const r of rarities) {
            if (r.name === "Glitched") continue;
            cumulative += r.chance;
            if (roll <= cumulative) {
              foundRarity = r.name;
              break;
            }
          }
        }

        if (doublePointsActive) multiplier *= 2;
        let basePoints = rarityPoints[foundRarity] || 0;
        let earned = basePoints * multiplier;
        points += earned;
        localStorage.setItem("points", points);
        updateShopDisplays();

        document.getElementById("result").innerText = "You got: " + foundRarity + " (+" + earned + " pts)";
        document.getElementById("result").className = foundRarity.toLowerCase().replace(/ /g, "-");

        if (!logData.includes(foundRarity)) {
          logData.push(foundRarity);
          localStorage.setItem("logData", JSON.stringify(logData));
          updateLogElement();
        }
        updateStats();
      }

      function purchaseAutoClicker() {
        const cost = 50 * shopPriceMultiplier;
        if (autoClickersCount >= 6) {
          alert("Auto Clickers Unavailable");
          return;
        }
        if (points >= cost) {
          points -= cost;
          localStorage.setItem("points", points);
          autoClickersCount++;
          updateShopDisplays();
          if (autoClickersCount === 1 && !timeFreezeActive) {
            autoInterval = setInterval(() => {
              for (let i = 0; i < autoClickersCount; i++) {
                generateRarity(false);
              }
            }, 2000);
          }
        } else {
          alert("Not enough pts for Auto Clicker!");
        }
      }

      function purchaseDoublePoints() {
        const cost = 150 * shopPriceMultiplier;
        if (points >= cost) {
          points -= cost;
          localStorage.setItem("points", points);
          doublePointsActive = true;
          updateShopDisplays();
          setTimeout(() => {
            doublePointsActive = false;
            updateShopDisplays();
          }, 30000);
        } else {
          alert("Not enough pts for Double Points!");
        }
      }

      function purchaseGoldenClick() {
        const cost = 200 * shopPriceMultiplier;
        if (points >= cost) {
          points -= cost;
          localStorage.setItem("points", points);
          goldenClickReady = true;
          updateShopDisplays();
        } else {
          alert("Not enough pts for Golden Click!");
        }
      }

      function purchaseLuckBoost() {
        const cost = 300 * shopPriceMultiplier;
        if (points >= cost) {
          points -= cost;
          localStorage.setItem("points", points);
          luckBoostActive = true;
          updateShopDisplays();
          setTimeout(() => {
            luckBoostActive = false;
            updateShopDisplays();
          }, 60000);
        } else {
          alert("Not enough pts for Luck Boost!");
        }
      }

      function purchaseTimeFreeze() {
        const cost = 200 * shopPriceMultiplier;
        if (points >= cost) {
          points -= cost;
          localStorage.setItem("points", points);
          updateShopDisplays();
          if (!timeFreezeActive) {
            timeFreezeActive = true;
            let freezeStart = Date.now();
            if (autoInterval) {
              clearInterval(autoInterval);
              autoInterval = null;
            }
            setTimeout(() => {
              timeFreezeActive = false;
              let freezeDuration = Date.now() - freezeStart;
              startTime += freezeDuration;
              localStorage.setItem("startTime", startTime);
              updateShopDisplays();
              if (autoClickersCount > 0) {
                autoInterval = setInterval(() => {
                  for (let i = 0; i < autoClickersCount; i++) {
                    generateRarity(false);
                  }
                }, 2000);
              }
            }, 30000);
          }
        } else {
          alert("Not enough pts for Time Freeze!");
        }
      }

      function purchaseGoldenMode() {
  const cost = 1500 * shopPriceMultiplier;
  if (points >= cost) {
    points -= cost;
    localStorage.setItem("points", points);
    updateShopDisplays();
    if (!goldenModeActive) {
      goldenModeActive = true;
      document.body.style.background = "#FFD700"; // Temporary gold mode background
      setTimeout(() => {
        goldenModeActive = false;
        setDefaultBackground();
        updateShopDisplays();
      }, 3000);
    }
  } else {
    alert("Not enough pts for Golden Mode!");
  }
}

function purchaseTimeWarp() {
  const cost = 500 * shopPriceMultiplier;
  if (points >= cost) {
    points -= cost;
    localStorage.setItem("points", points);
    timeWarpActive = true;
    updateShopDisplays();
    // Speed up auto clickers by 50%
    if (autoClickersCount > 0 && !timeFreezeActive) {
      clearInterval(autoInterval);
      autoInterval = setInterval(() => {
        for (let i = 0; i < autoClickersCount; i++) {
          generateRarity(false);
        }
      }, 1333);
    }
    setTimeout(() => {
      timeWarpActive = false;
      if (autoClickersCount > 0 && !timeFreezeActive) {
        clearInterval(autoInterval);
        autoInterval = setInterval(() => {
          for (let i = 0; i < autoClickersCount; i++) {
            generateRarity(false);
          }
        }, 2000);
      }
      updateShopDisplays();
    }, 30000);
  } else {
    alert("Not enough pts for Time Warp!");
  }
}

function purchaseStabilizer() {
  const cost = 1200 * shopPriceMultiplier;
  if (points >= cost) {
    points -= cost;
    localStorage.setItem("points", points);
    stabilizerActive = true;
    updateShopDisplays();
    // Stabilizer: Prevent getting "Dusty", "Basic", or "Standard" for 3 minutes.
    let originalGenerate = generateRarity;
    generateRarity = function(isManual) {
      let found = "";
      while (true) {
        originalGenerate(isManual);
        found = logData[logData.length - 1];
        if (["Dusty", "Basic", "Standard"].indexOf(found) === -1) break;
      }
    };
    setTimeout(() => {
      stabilizerActive = false;
      generateRarity = originalGenerate;
      updateShopDisplays();
    }, 180000);
  } else {
    alert("Not enough pts for Stabilizer!");
  }
}

function updateBackgroundShop() {
  const list = document.getElementById("backgroundShopList");
  list.innerHTML = "";

  const headerFixed = document.createElement("h5");
  headerFixed.textContent = "Permanent Backgrounds";
  list.appendChild(headerFixed);

  for (const bgName in backgroundsPermanent) {
    const bgData = backgroundsPermanent[bgName];
    const li = document.createElement("li");
    li.style.background = bgData.color;
    const textOverlay = document.createElement("div");
    textOverlay.style.backgroundColor = "rgba(255, 255, 255, 0.7)";
    textOverlay.style.padding = "5px";
    textOverlay.textContent = `${bgName} - ${bgData.cost} pts (Requires ${bgData.requiredRarity})`;
    li.appendChild(textOverlay);

    if (ownedBackgrounds[bgName]) {
      if (activeBackground === bgName) {
        const activeLabel = document.createElement("div");
        activeLabel.textContent = "Active";
        activeLabel.style.backgroundColor = "rgba(0,0,0,0.7)";
        activeLabel.style.color = "white";
        activeLabel.style.padding = "5px";
        li.appendChild(activeLabel);
      } else {
        const selectBtn = document.createElement("button");
        selectBtn.textContent = "Select";
        selectBtn.onclick = () => setBackground(bgName);
        li.appendChild(selectBtn);
      }
    } else {
      if (points >= bgData.cost && logHasRarity(bgData.requiredRarity)) {
        const buyBtn = document.createElement("button");
        buyBtn.textContent = "Buy";
        buyBtn.onclick = () => purchaseBackground(bgName);
        li.appendChild(buyBtn);
      } else {
        li.classList.add("disabled");
      }
    }
    list.appendChild(li);
  }
  updateSeasonalBackgroundShop();
}

function updateSeasonalBackgroundShop() {
  const list = document.getElementById("backgroundShopList");
  const headerMain = document.createElement("h5");
  headerMain.textContent = "Seasonal Backgrounds";
  list.appendChild(headerMain);

  const now = new Date();
  const currentMonth = now.getMonth();

  seasonalMainBackgrounds.forEach(bg => {
    let available = false;
    if (bg.availableMonths) {
      if (bg.availableMonths.includes(currentMonth)) {
        available = true;
      }
    } else if (bg.availableDates) {
      if (now >= bg.availableDates.start && now <= bg.availableDates.end) {
        available = true;
      }
    }
    if (available) {
      const li = document.createElement("li");
      li.style.background = bg.color;
      li.style.position = "relative";
      const textOverlay = document.createElement("div");
      textOverlay.style.backgroundColor = "rgba(255, 255, 255, 0.7)";
      textOverlay.style.padding = "5px";
      textOverlay.textContent = `${bg.name} - ${bg.cost} pts`;
      li.appendChild(textOverlay);

      if (ownedSeasonalBackgrounds[bg.name]) {
        if (activeSeasonalBackground === bg.name) {
          const activeLabel = document.createElement("div");
          activeLabel.textContent = "Active";
          activeLabel.style.backgroundColor = "rgba(0,0,0,0.7)";
          activeLabel.style.color = "white";
          activeLabel.style.padding = "5px";
          li.appendChild(activeLabel);
        } else {
          const selectBtn = document.createElement("button");
          selectBtn.textContent = "Select";
          selectBtn.onclick = () => setSeasonalBackground(bg.name, bg.color);
          li.appendChild(selectBtn);
        }
      } else {
        if (points >= bg.cost) {
          const buyBtn = document.createElement("button");
          buyBtn.textContent = "Buy";
          buyBtn.onclick = () => {
            points -= bg.cost;
            localStorage.setItem("points", points);
            ownedSeasonalBackgrounds[bg.name] = true;
            localStorage.setItem("ownedSeasonalBackgrounds", JSON.stringify(ownedSeasonalBackgrounds));
            updateShopDisplays();
            updateSeasonalBackgroundShop();
          };
          li.appendChild(buyBtn);
        } else {
          li.classList.add("disabled");
        }
      }
      list.appendChild(li);
    }
  });

  const headerEvent = document.createElement("h5");
  headerEvent.textContent = "Special Event Backgrounds";
  list.appendChild(headerEvent);

  seasonalEventBackgrounds.forEach(bg => {
    let available = false;
    if (bg.availableDates) {
      if (new Date() >= bg.availableDates.start && new Date() <= bg.availableDates.end) {
        available = true;
      }
    } else if (bg.availableMonths) {
      if (bg.availableMonths.includes(currentMonth)) {
        available = true;
      }
    }
    if (available) {
      const li = document.createElement("li");
      li.style.background = bg.color;
      li.style.position = "relative";
      const limitedIcon = document.createElement("div");
      limitedIcon.textContent = "üïò";
      limitedIcon.className = "seasonal-event-icon";
      li.appendChild(limitedIcon);
      const textOverlay = document.createElement("div");
      textOverlay.style.backgroundColor = "rgba(255, 255, 255, 0.7)";
      textOverlay.style.padding = "5px";
      textOverlay.textContent = `${bg.name} - ${bg.cost} pts`;
      li.appendChild(textOverlay);

      if (ownedSeasonalBackgrounds[bg.name]) {
        if (activeSeasonalBackground === bg.name) {
          const activeLabel = document.createElement("div");
          activeLabel.textContent = "Active";
          activeLabel.style.backgroundColor = "rgba(0,0,0,0.7)";
          activeLabel.style.color = "white";
          activeLabel.style.padding = "5px";
          li.appendChild(activeLabel);
        } else {
          const selectBtn = document.createElement("button");
          selectBtn.textContent = "Select";
          selectBtn.onclick = () => setSeasonalBackground(bg.name, bg.color);
          li.appendChild(selectBtn);
        }
      } else {
        if (points >= bg.cost) {
          const buyBtn = document.createElement("button");
          buyBtn.textContent = "Buy";
          buyBtn.onclick = () => {
            points -= bg.cost;
            localStorage.setItem("points", points);
            ownedSeasonalBackgrounds[bg.name] = true;
            localStorage.setItem("ownedSeasonalBackgrounds", JSON.stringify(ownedSeasonalBackgrounds));
            updateShopDisplays();
            updateSeasonalBackgroundShop();
          };
          li.appendChild(buyBtn);
        } else {
          li.classList.add("disabled");
        }
      }
      list.appendChild(li);
    }
  });
}

function purchaseBackground(bgName) {
  const bgData = backgroundsPermanent[bgName];
  if (!bgData || points < bgData.cost || !logHasRarity(bgData.requiredRarity)) return;
  points -= bgData.cost;
  localStorage.setItem("points", points);
  ownedBackgrounds[bgName] = true;
  localStorage.setItem("ownedBackgrounds", JSON.stringify(ownedBackgrounds));
  updateShopDisplays();
  updateBackgroundShop();
}

function setBackground(bgName) {
  if (!ownedBackgrounds[bgName]) return;
  activeBackground = bgName;
  localStorage.setItem("activeBackground", bgName);
  if (bgName === "Rainbow") {
    document.body.style.background = "linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)";
  } else if (backgroundsPermanent[bgName]) {
    document.body.style.background = backgroundsPermanent[bgName].color;
  } else {
    document.body.style.background = "";
  }
}

function setSeasonalBackground(bgName, color) {
  activeSeasonalBackground = bgName;
  localStorage.setItem("activeSeasonalBackground", bgName);
  document.body.style.background = color;
}

function logHasRarity(requiredRarity) {
  return logData.includes(requiredRarity);
}

function toggleSettingsModal() {
  const modal = document.getElementById("settingsModal");
  modal.style.display = (modal.style.display === "block") ? "none" : "block";
  updateShopDisplays();
  updateBackgroundShop();
  updateStats();
}

function resetGame() {
  if (confirm("Are you sure you want to reset the game? This will clear all progress.")) {
    points = 0;
    localStorage.setItem("points", points);
    autoClickersCount = 0;
    doublePointsActive = false;
    goldenClickReady = false;
    luckBoostActive = false;
    timeFreezeActive = false;
    goldenModeActive = false;
    ownedBackgrounds = {};
    activeBackground = "Light Blue";
    localStorage.removeItem("ownedBackgrounds");
    localStorage.removeItem("activeBackground");
    localStorage.removeItem("logData");
    localStorage.removeItem("totalClicks");
    logData = [];
    totalClicks = 0;
    ownedSeasonalBackgrounds = {};
    localStorage.removeItem("ownedSeasonalBackgrounds");
    activeSeasonalBackground = "";
    localStorage.removeItem("activeSeasonalBackground");
    if (autoInterval) {
      clearInterval(autoInterval);
      autoInterval = null;
    }
    document.getElementById("log").innerHTML = "";
    updateShopDisplays();
    startTime = Date.now();
    localStorage.setItem("startTime", startTime);
    setDefaultBackground();
    updateBackgroundShop();
    updateStats();
  }
}

function setDefaultBackground() {
  if (activeBackground === "Light Blue") {
    document.body.style.background = "#e0f7fa";
  } else if (backgroundsPermanent[activeBackground]) {
    document.body.style.background = backgroundsPermanent[activeBackground].color;
  } else if (activeBackground === "Rainbow") {
    document.body.style.background = "linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)";
  }
}
</script>
  </body>
</html>